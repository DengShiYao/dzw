<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>结算中心</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
	<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<style>
		.bg {
			background-color: blanchedalmond;
		}
	</style>
</head>

<body>
	<div id="ctn" class="container-fluid">
		<div class="row" style="background-color: rgb(247,255,255);display: flex; align-items: center;height: 50px;">
			<span style="font-size: 25px;margin-left: 20px;">结算中心</span>
			<button class="btn btn-success" style="margin-left: 80%;" @click="selSalStatusByParse">
				<span class="glyphicon glyphicon-search" aria-hidden="true"></span>
				查询
			</button>
			<button class="btn" style="margin-left: 10px;">
				<span class="glyphicon glyphicon-off" aria-hidden="true"></span>
				关闭
			</button>
		</div>
		<div class="row" style="background-color: rgb(247,247,247);height: 40px;"></div>
		<div class="row" style="border-top: 1px solid rgb(33,182,206);">
			<form class="form-inline">
				<div style="margin-top: 10px;">
					<div class="form-group" style="margin-left: 35px;">
						<label for="exampleInputName2" style="color: rgb(33,182,206);">开单日期</label>
						<input type="date" class="form-control" id="exampleInputName2" style="width: 150px;" v-model="saleQuerry.settlementBenginTime">
						<input type="date" class="form-control" id="exampleInputName2" style="width: 150px;" v-model="saleQuerry.settlementEndTime">
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">销售单号</label>
						<input type="text" class="form-control" id="exampleInputEmail2" style="width: 120px;" v-model="saleQuerry.salesOrder">
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">结算状态</label>
						<input type="text" class="form-control" id="exampleInputEmail2" style="width: 120px;"  v-model="saleQuerry.settlementStatus">
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">车牌号</label>
						<input type="text" class="form-control" id="exampleInputEmail2" style="width: 150px;"  v-model="saleQuerry.plateNumber">
					</div>
				</div>

				<div style="margin-top: 10px;margin-bottom: 10px;">
					<div class="form-group" style="margin-left: 34px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">客户名称</label>
						<input class="form-control"  style="width: 150px;" v-model="saleQuerry.username"/>
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">服务顾问</label>
						<input name="" class="form-control" id="exampleInputEmail2" style="width: 150px;"  v-model="saleQuerry.serviceAdviser"/>
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">业务类型</label>
						<select name="" class="form-control" id="exampleInputEmail2" style="width: 150px;"  v-model="saleQuerry.serviceType">
							<option value="item.serviceType" v-for="item in serviceTypeList" v-text="item.serviceType"></option>
						</select>
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">单据类型</label>
						<select name="" class="form-control" id="exampleInputEmail2" style="width: 150px;"  v-model="saleQuerry.billsType">
							<option value="维修">维修</option>
							<option value="救援">救援</option>
						</select>
					</div>
					<div class="form-group" style="margin-left: 10px;">
						<label for="exampleInputEmail2" style="color: rgb(33,182,206);">备注</label>
						<input type="text" class="form-control" id="exampleInputEmail2" style="width: 150px;"  v-model="saleQuerry.remarks">
					</div>
			</form>
		</div>
	</div>


	<div class="row" style="height: 40px;background-color: rgb(247,247,247);display: flex; align-items: center;">
		<a  class="btn btn-primary"  style="font-size: 20px;color: black;margin-left: 20px;" @click="mendian()">
			<span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
			门店选择
		</a>
		<a  class="btn btn-primary" style="font-size: 20px;color: black;margin-left: 60.5%;" @click="sy()">
			<span class="glyphicon glyphicon-yen" aria-hidden="true"></span>
			收银
		</a>
		<a class="btn btn-primary"  style="font-size: 20px;color: black;margin-left: 100px;" @click="showRepair">
			<span class="glyphicon glyphicon-search" aria-hidden="true"></span>
			打开单据
		</a>
		<a class="btn btn-primary"  style="font-size: 20px;color: black;margin-left: 35px;" @click="daochu" >
			<span class="glyphicon glyphicon-cloud-download" aria-hidden="true"></span>
			导出
		</a>
	</div>

	<div class="row">
		<table class="table table-bordered">
			<tr style="background-color: rgb(33,182,206); color: white;">
				<td>销售单号</td>
				<td>单据类型</td>
				<td>结算方式</td>
				<td>单据状态</td>
				<td>结算状态</td>
				<td>结算时间</td>
				<td>结算人</td>
				<td>结算金额</td>
				<td>业务类型</td>
				<td>客户名称</td>
				<td>车牌号</td>
				<td>车型</td>
				<td>车架号</td>
				<td>联系电话</td>
				<td>保险公司</td>
				<td>赔款公司</td>
				<td>对方车牌</td>
				<td>服务顾问</td>
				<td>完工时间</td>
				<td>备注</td>
			</tr>
			<tr v-for="(item,index) in saleTable" :class='{bg:index==isactive}' @click="fn(index)">
				<td v-text="item.salesOrder" @click="chooseTableTr(item)"></td>
				<td v-if="item.billsType" v-text="item.billsType" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.balance" v-text="item.balance" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.billstatus" v-text="item.billstatus" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.settlementStatus" v-text="item.settlementStatus" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.settlementTime" v-text="item.settlementTime" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.settlementUser" v-text="item.settlementUser" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.settlementMoney" v-text="item.settlementMoney" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.serviceType" v-text="item.serviceType" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.username" v-text="item.username" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.plateNumber" v-text="item.plateNumber" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.motorcycleType" v-text="item.motorcycleType" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.frame" v-text="item.frame" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.phone" v-text="item.phone" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.insurer" v-text="item.insurer" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.indemnityCompany" v-text="item.indemnityCompany" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.licensePlate" v-text="item.licensePlate" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.serviceAdviser" v-text="item.serviceAdviser" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.completionTime" v-text="item.completionTime" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
				<td v-if="item.remarks" v-text="item.remarks" @click="chooseTableTr(item)"></td>
				<td v-else @click="chooseTableTr(item)"></td>
			</tr>

		</table>
	</div>


	<!--模态框-->
	<div class="modal" data-backdrop="static" id="mymodal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<span class="close" data-dismiss="modal">&times;</span>
					<h3>前台收银</h3>
				</div>
				<div class="modal-body" style="display: flex;justify-content: center;">
					<div>
						<div id="code"></div>
					</div>
				</div>
				<div class="modal-footer">
				</div>
			</div>
		</div>
	</div>


	<!--模态框-->
	<div class="modal" data-backdrop="static" id="mymodal2">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<span class="close" data-dismiss="modal">&times;</span>
					<span style="font-size: 25px;margin-left: 10px;">门店选择</span>
					<input type="text" placeholder="匹配门店编码/门店" id="searchStore" style="margin-left: 25%;width: 150px;height: 33px;">
					<button class="btn btn-primary" style="margin-left: 10px;" @click="searchStore">搜索</button>
					<button class="btn" style="margin-left: 10px;" @click="closeStoreChoose">关闭</button>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<div class="row">
							<button class="btn btn-success"  @click="selSaleByStore">确定</button>
							<button class="btn btn-default" style="margin-left: 60%;"@click="checkAllStore(true)" >全部选择</button>
							<button class="btn btn-default" @click="checkAllStore(false)">全部取消</button>
						</div>
						<div class="row">
							<table class="table table-bordered table-striped table-hover">
								<tr style="background-color: rgb(33,182,206); color: white;">
									<td>选择</td>
									<td>门店代码</td>
									<td>门店名称</td>
									<td>所在城市</td>
								</tr>
								<tr v-for="item in storeList">
									<td>
										<input type="checkbox" id="" :value="item.storeId" v-model="storeChecks" />
									</td>
									<td>{{item.storeId}}</td>
									<td>{{item.storeName}}</td>
									<td></td>
								</tr>
							</table>
						</div>
					</div>

				</div>
				<div class="modal-footer">
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade bs-example-modal-lg" id="repairModal"  style="width: 100%;height: 100%;">
		<div class="modal-dialog" style="width: 100%;height: 100%;">
			<div class="modal-content" style="display:inline-block;width: 100%;">
				<div class="modal-header" style="width: 100%;height: 100%;">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title">Modal title</h4>
				</div>
				<div class="modal-body" style="width: 100%;height: 500px;">
					<iframe src="维修单.html"  ref="iframe" frameborder="0" width="100%"
					height="100%" scrolling:no></iframe>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
	



	</div>

	<script src="js/jquery-1.12.4.js"></script>
	<script src="js/qrcode.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/vue-2.6.js"></script>
	<script>
		new Vue({
			el: "#ctn",
			data() {
				return {
					weixin: true,
					zhifubao: false,
					//销售单list
					saleTable: [],
					//被选择的销售单
					chooseSaleTr: {},
					isactive: -1,
					code: "",
					settimebool: true,
					//防止重复提交
					post_flag: false,
					order: {
						orderid: '',
						column1: 0.01,
						column3: 1,
						subject: "DZW结算"
					},
					//销售单查询对象
					saleQuerry:{},
					//业务类型list
					serviceTypeList:[],
					//门店list
					storeList:[],
					storeChecks:[],
					//传输维修单对象
					repair:{}
				}
			},
			methods: {
				sy() {
					/* if(this.chooseSaleTr==null||this.chooseSaleTr==""||this.chooseSaleTr==undefined){
						alert("请先单击选择要操作行");
						return;
					} */
					var price = this.chooseSaleTr.settlementMoney;
					if (price == "" || price == null || price == undefined) {
						alert("请先点击要结算的销售单");
						return;
					}
					this.btnFactoryOrder();
					$("#mymodal").modal("show");

				},
				weixin1() {
					this.weixin = true;
					this.zhifubao = false
				},
				zhifubao1() {
					this.weixin = false;
					this.zhifubao = true
				},
				mendian() {
					this.selStoreList();
					$("#mymodal2").modal("show");
				},
				//查询所有的销售单信息
				selAllXiaoShou() {
					let that = this;
					$.ajax({
						url: "http://127.0.0.1:8080/listOfSales/selAll",
						type: "get",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						async: false,
						dataType: "json",
						success: function (result) {
							console.log(result);
							that.saleTable = result;
							that.selServiceTypeList();
						}
					});
				},
				//选择table某列将数据传入，用于获取销售单信息
				chooseTableTr(item) {
					this.chooseSaleTr = item;
					console.log(this.chooseSaleTr);
				},
				//点击tr背景变色
				fn(index) {
					//点击切换 变量的值 赋值为 index
					this.isactive = index;
				},
				btnFactoryOrder() {
					if (this.post_flag) {
						return;
					}
					this.post_flag = true;
					this.insertOrder();
				},
				pay() {
					let that = this;
					// console.log("http://127.0.0.1:8080//qrcode?totalAmount=" + this.order.totalAmount + "&subject=" + this.order.subject + "&storeId=123456&timeoutExpress=5m&outTradeNo=" + this.order.orderid);
					$.ajax({
						// url: "http://127.0.0.1:8080//qrcode?totalAmount=0.00&subject=支付宝扫码支付测试&storeId=123456&timeoutExpress=5m&outTradeNo=132131313132",
						url: "http://127.0.0.1:8080/dingdan/qrcode?storeId=123456&timeoutExpress=5m&outTradeNo=" + this.order.orderid,
						type: "get",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						contentType: "application/json;charset=utf-8",
						dataType: "json",
						success: function (result) {
							that.code = result.qr_code;
							// new QRCode(document.getElementById("code"), result.qr_code);
							var qrcode = new QRCode("code", {
								text: result.qr_code,
								width: 256,
								height: 256,
								colorDark: "#000000",
								colorLight: "#ffffff",
								correctLevel: QRCode.CorrectLevel.H
							});
							that.requestPya(that.order.orderid);
						}
					});
				},
				/*给数据库中新增订单*/
				insertOrder() {
					let that = this;
					var price = this.chooseSaleTr.settlementMoney;
					console.log(price);
					this.order.column1 = price;
					console.log(this.order);
					$.ajax({
						url: "http://127.0.0.1:8080/dingdan/factoryorderid",
						type: "post",
						data: that.order,
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						dataType: "json",
						success: function (result) {
							that.post_flag = true;
							if (result.code == "1000") {
								console.log("成功" + result.data);
								that.order.orderid = result.data;
								//生成二维码
								that.pay();
							} else if (result.code == "3000") {
								alert('重新尝试');
							} else if (result.code == "2002") {
								alert('未登录');
							}
						}
					});
				},
				/*
					查询订单当前的支付状态
				*/
				requestPya(orderid) {
					var interval = setInterval(() => {
						let that = this;
						$.ajax({
							url: "http://127.0.0.1:8080/dingdan/findorderid",
							type: "post",
							data: { orderid: orderid },
							xhrFields: {
								withCredentials: true
							},
							crossDomain: true,
							dataType: "json",
							success: function (result) {
								console.log(JSON.stringify(result))
								if (result.code == "1000") {
									if (result.data === 1) {
										console.log("未支付");
									} else if (result.data === 2) {
										clearInterval(interval);
										console.log("支付成功");
										alert('支付成功');
										$("#mymodal").modal("hide");
										that.changeSaleStaus();
										location.reload();
										return;
									} if (result.data === 3) {
										clearInterval(interval);
										console.log("支付超时，二维码失效");
									}
								}
							}
						});
					}, 500);
				},
				//修改销售单状态
				changeSaleStaus() {
					let that = this;
					this.chooseSaleTr.settlementStatus = "已结算";
					this.chooseSaleTr.settlementUser = this.chooseSaleTr.username;
					console.log(this.chooseSaleTr);
					var json = JSON.stringify(this.chooseSaleTr);
					$.ajax({
						url: "http://127.0.0.1:8080/listOfSales/updateListOfSale",
						type: "post",
						data: { json: JSON.stringify(that.chooseSaleTr) },
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function (result) {
							alert(result);
						}
					});
				},
				//多条件查询
				selSalStatusByParse(){
					if(this.saleQuerry.settlementBenginTime>=this.saleQuerry.settlementEndTime){	
						alert("开单结束时间不能前于开单开始时间");
						return;
					}
					let that = this;
					$.ajax({
						url: "http://127.0.0.1:8080/listOfSales/selBy",
						type: "get",
						data: { json: JSON.stringify(that.saleQuerry)},
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function (result) {
							that.saleTable=result;
							that.selServiceTypeList();
						}
					});
				},
				//查询业务类型
				selServiceTypeList(){
					let that = this;
					$.ajax({
						url: "http://127.0.0.1:8080/listOfSales/selAllServiceType",
						type: "get",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function (result) {
							that.serviceTypeList=result;
						}
					});
				},
				//查询所有的门店
				selStoreList(){
					let that = this;
					$.ajax({
						url: "http://127.0.0.1:8080/store",
						type: "get",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function (result) {
							that.storeList=result;
						}
					});
				},
				//全选门店或者全部取消
				checkAllStore(c){
					if(!c){
						 alert("取消全选");
						 this.storeChecks=[];
					}else{
						alert("全选");
						this.storeChecks= this.storeList.map(item=>item.storeId);
					}
				},
				//按条件查询门店
				searchStore(){
					var parse = $("#searchStore").val();
					if(parse==null||parse==''){
						this.selStoreList();
						return;
					}
					let that=this;
					$.ajax({
						url:"http://127.0.0.1:8080/store/selStoreFuzzy/"+parse,
						dataType:"json",
						type:"get",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						async:false,
						success:function(result){
							console.log(result);
							that.storeList=result;
							console.log(that.storeList);
						}
					});
				},
				//关闭门店模态框
				closeStoreChoose(){
					$("#mymodal2").modal("hide");
				},		
			  //根据门店查询销售单记录
			  selSaleByStore(){
				alert("11111");
				let that=this;
					$.ajax({
						url:"http://127.0.0.1:8080/listOfSales/selByStore",
						data:JSON.stringify(that.storeChecks),
						dataType:"json",
						type:"post",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						async:false,
						contentType:"application/json;charset=utf-8",
						success:function(result){
							console.log(result);
							that.saleTable=result;
							$("#mymodal2").modal("hide");
						}
					});
			  },
			  //显示维修单模态框
			  showRepair(){
				if(this.chooseSaleTr.column1==""||this.chooseSaleTr.column1==null||this.chooseSaleTr.column1==undefined){
					alert("请选择要操作的行");
					return;
				  }
				$("#repairModal").modal("show");
				 //像子页面传值
				 this.iframe = this.$refs.iframe;
                 this.iframeWindow = this.iframe.contentWindow;
				 this.repair.serNumber=this.chooseSaleTr.column1;
				 this.repair.setButtonStatus=2;
				 this.repair.jsLogo=true;
				 message = {
                    aa: 'jiesuan',
                    val: this.repair,
                    }
                this.iframeWindow.postMessage(message, '*');
			  },
			  //导出
			  daochu(){
					var eList=[];
					this.saleTable.forEach(
						item=>{eList.push(item.salesOrder);
					});
					console.log(eList);
					var lzList=eList.toString();
					alert(lzList);
					window.location.href="http://127.0.0.1:8080/listOfSales/downLoadExportExcel?lzList="+List;
			  }

			},
			created() {
				this.chooseSaleTr = {};
				this.selAllXiaoShou();
			}
		})
	</script>
</body>

</html>